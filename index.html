<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Hype Oracle</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tonweb@0.0.66/dist/tonweb.js"></script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; padding: 15px; margin: 0; display: flex; flex-direction: column; align-items: center; }
    #app { width: 100%; max-width: 420px; }
    .header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 16px; padding: 0 4px; }
    .logo { font-size: 22px; font-weight: 800; color: #111827; letter-spacing: -0.5px;}
    .fiat-banner { background: linear-gradient(135deg, #0088cc, #005580); color: white; border-radius: 20px; padding: 16px 20px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; width: 100%; cursor: pointer; box-shadow: 0 8px 20px rgba(0, 136, 204, 0.25); transition: transform 0.1s; }
    .fiat-banner-btn { background: #fff; color: #0088cc; padding: 10px 14px; border-radius: 999px; font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 4px; }
    .filters { display: flex; gap: 8px; overflow-x: auto; padding: 6px 2px 12px 2px; margin-bottom: 6px; scrollbar-width: none; }
    .chip { flex: 0 0 auto; padding: 10px 12px; border-radius: 999px; border: 1px solid #e5e7eb; background: #fff; color: #111827; font-weight: 800; font-size: 13px; cursor: pointer; }
    .chip.active { background: #111827; color: #fff; border-color: #111827; }
    .card { background: #fff; border-radius: 24px; padding: 22px; box-shadow: 0 10px 25px rgba(0,0,0,0.06); margin-bottom: 16px; }
    .event-img { width: 100%; height: 160px; border-radius: 18px; margin: 8px 0 14px 0; display: block; object-fit: cover; background: #f3f4f6; }
    .poll-container { height: 12px; background: #eee; border-radius: 6px; display: flex; overflow: hidden; margin-bottom: 10px; }
    .poll-yes { background: #34c759; transition: width 0.6s; }
    .poll-no { background: #ff3b30; transition: width 0.6s; }
    .stats-text { display: flex; justify-content: space-between; font-weight: 700; font-size: 12px; margin-bottom: 14px; color: #666; }
    input { width: 100%; height: 56px; border: 2px solid #e0e0e0; border-radius: 16px; font-size: 22px; font-weight: 900; text-align: center; outline: none; }
    .hint { font-size: 12px; color: #888; margin: 8px 0; text-align: center; }
    .win-estimate { font-size: 13px; color: #0088cc; font-weight: 650; margin-bottom: 12px; text-align: center; min-height: 40px; }
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    button { padding: 16px; border-radius: 16px; border: none; color: #fff; font-size: 16px; font-weight: 850; cursor: pointer; }
    .btn-yes { background: #34c759; box-shadow: 0 4px 0 #28a745; }
    .btn-no { background: #ff3b30; box-shadow: 0 4px 0 #d93025; }
    .meta { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 11px; }
    .share-btn { background: #f3f4f6; color: #374151; padding: 6px 12px; border-radius: 999px; font-weight: 700; border: 1px solid #e5e7eb; cursor: pointer; }
    .loading { color: #888; margin-top: 50px; }
  </style>
</head>
<body>
  <div id="app">
    <div class="header"><div class="logo">üèÜ HypeOracle</div><div id="ton-connect"></div></div>
    <div class="fiat-banner" onclick="openFiatOnRamp()"><div class="fiat-banner-text">–ù–µ—Ç TON –¥–ª—è —Å—Ç–∞–≤–∫–∏?<br><span>–ü–æ–ø–æ–ª–Ω–∏ —Å –∫–∞—Ä—Ç—ã –ª–µ–≥–∞–ª—å–Ω–æ</span></div><div class="fiat-banner-btn">–ö—É–ø–∏—Ç—å üí≥</div></div>
    <div id="content"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
  </div>
  <script>
    const tg = window.Telegram?.WebApp;
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'https://footballtv993-del.github.io/Index1/tonconnect-manifest.json', buttonRootId: 'ton-connect' });
    const CONTRACT = "–¢–í–û–ô_–ù–û–í–´–ô_–ê–î–†–ï–°_–ó–î–ï–°–¨";
    const BOT_USERNAME = "–¢–í–û–ô_–ë–û–¢_–Æ–ó–ï–†–ù–ï–ô–ú";
    const MIN_BET = 0.10;
    const BET_NETWORK_FEE = 0.05;
    let eventList = [], activeCategory = "all", state = new Map();

    function openFiatOnRamp() { tg.openTelegramLink("https://t.me/wallet"); }
    function shareEvent(id, title) { tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent('https://t.me/'+BOT_USERNAME+'?start=ev_'+id)}&text=${encodeURIComponent('üî• –°–ø–æ—Ä–∏–º? '+title)}`); }

    function isNullOptionalEvent(stack) {
      if (!Array.isArray(stack) || stack.length === 0 || stack[0] === null) return true;
      const s0 = stack[0];
      if (s0 === "null" || s0.type === "null" || (Array.isArray(s0) && s0[0] === "null")) return true;
      return false;
    }

    function asBigIntFromElement(el) {
      const v = el?.value ?? el?.num ?? el?.[1];
      try { return BigInt(v); } catch(e) { return null; }
    }

    async function fetchAllEvents(ids) {
      const API_KEY = new URLSearchParams(window.location.search).get("api");
      const url = `https://toncenter.com/api/v2/jsonRPC?api_key=${API_KEY}`;
      for (const id of ids) {
        try {
          const res = await fetch(url, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({id:id, jsonrpc:"2.0", method:"runGetMethod", params:{address:CONTRACT, method:"get_event", stack:[["num", String(id)]]}})});
          const json = await res.json();
          if (isNullOptionalEvent(json.result?.stack)) {
            state.set(id, {yes:0, no:0, total:0, isResolved:false, lastSyncAt:Date.now()});
          } else {
            const st = json.result.stack[0][1].elements;
            state.set(id, {yes:Number(asBigIntFromElement(st[0]))/1e9, no:Number(asBigIntFromElement(st[1]))/1e9, total:(Number(asBigIntFromElement(st[0]))+Number(asBigIntFromElement(st[1])))/1e9, isResolved:st[2].value==="true", winningOutcome:st[3].value==="true", lastSyncAt:Date.now()});
          }
          renderFromState(id);
        } catch(e) { console.error(e); }
      }
    }

    function renderEstimate(id) {
      const info = state.get(id);
      const ev = eventList.find(e => e.id == id);
      const val = parseFloat(document.getElementById(`am-${id}`).value) || 0;
      const est = document.getElementById(`est-${id}`);
      if (val < MIN_BET) { est.textContent = "–ú–∏–Ω–∏–º—É–º 0.10 TON"; return; }
      const fee = ev.is_private ? 0.98 : 0.90; // 2% –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö, 10% –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö
      const winYes = val + (val / (info.yes + val)) * (info.no * fee);
      const winNo = val + (val / (info.no + val)) * (info.yes * fee);
      est.innerHTML = `–ü–æ–±–µ–¥–∞ –î–ê: ~${winYes.toFixed(2)} T<br>–ü–æ–±–µ–¥–∞ –ù–ï–¢: ~${winNo.toFixed(2)} T`;
    }

    function renderFromState(id) {
      const info = state.get(id);
      const yP = info.total > 0 ? Math.round((info.yes/info.total)*100) : 50;
      document.getElementById(`bar-y-${id}`).style.width = yP+'%';
      document.getElementById(`bar-n-${id}`).style.width = (100-yP)+'%';
      document.getElementById(`txt-y-${id}`).textContent = `–î–ê: ${yP}% (${info.yes.toFixed(2)}T)`;
      document.getElementById(`txt-n-${id}`).textContent = `–ù–ï–¢: ${100-yP}% (${info.no.toFixed(2)}T)`;
    }

    async function doBet(id, outcome) {
      if (!tonConnectUI.connected) { tonConnectUI.connectWallet(); return; }
      const amt = parseFloat(document.getElementById(`am-${id}`).value);
      const cell = new TonWeb.boc.Cell();
      cell.bits.writeUint(0x336af5ef, 32); cell.bits.writeUint(id, 64); cell.bits.writeUint(outcome?1:0, 1);
      const boc = await cell.toBoc();
      await tonConnectUI.sendTransaction({validUntil: Math.floor(Date.now()/1000)+300, messages: [{address: CONTRACT, amount: Math.floor((amt+BET_NETWORK_FEE)*1e9).toString(), payload: TonWeb.utils.bytesToBase64(boc)}]});
    }

    function renderApp() {
      const root = document.getElementById("content"); root.innerHTML = "";
      eventList.forEach(ev => {
        if (activeCategory !== "all" && ev.category !== activeCategory) return;
        const card = document.createElement("div"); card.className = "card";
        card.innerHTML = `<h2>${ev.is_private?'üîí ':''}${ev.title}</h2>${ev.image_url?`<img src="${ev.image_url}" class="event-img">`:''}
          <div class="poll-container"><div id="bar-y-${ev.id}" class="poll-yes"></div><div id="bar-n-${ev.id}" class="poll-no"></div></div>
          <div class="stats-text"><span id="txt-y-${ev.id}">–î–ê: --</span><span id="txt-n-${ev.id}">–ù–ï–¢: --</span></div>
          <input type="number" id="am-${ev.id}" placeholder="–°—É–º–º–∞ TON" oninput="renderEstimate(${ev.id})">
          <div class="hint">–ú–∏–Ω–∏–º—É–º 0.10 TON</div><div id="est-${ev.id}" class="win-estimate"></div>
          <div class="btn-grid"><button class="btn-yes" onclick="doBet(${ev.id}, true)">–î–ê</button><button class="btn-no" onclick="doBet(${ev.id}, false)">–ù–ï–¢</button></div>
          <div class="meta"><span id="status-${ev.id}"></span><button class="share-btn" onclick="shareEvent(${ev.id}, '${ev.title}')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚ÜóÔ∏è</button></div>`;
        root.appendChild(card);
      });
      fetchAllEvents(eventList.map(e => e.id));
    }

    (function main() {
      const params = new URLSearchParams(window.location.search);
      eventList = JSON.parse(atob(params.get("data")));
      renderApp();
      const target = params.get("ev");
      if (target) setTimeout(() => { document.querySelector(`[onclick*="shareEvent(${target}"]`)?.scrollIntoView({behavior:"smooth"}); }, 800);
    })();
  </script>
</body>
</html>
